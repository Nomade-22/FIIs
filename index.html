<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FIIs • Carteira & Calculadora (v1.4)</title>
  <style>
    :root{
      --bg:#0a0f24; --panel:#0f1532; --muted:#182151; --text:#e9ecf4; --sub:#b9c2e6;
      --accent:#7dd3fc; --accent2:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --table-head:#0c1233; --chip:#0e1742;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% -10%,#1b2a6a 0%,#0a0f24 45%),
        linear-gradient(180deg,#0a0f24,#0a0f24);
      font:500 15px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    }
    .wrap{max-width:1200px;margin:auto;padding:24px}
    .card{
      background:linear-gradient(180deg,var(--panel),#0b1230);
      border:1px solid #233069;border-radius:18px;
      box-shadow:0 20px 50px rgba(0,0,0,.35);padding:20px;margin-bottom:18px
    }
    h1{font-size:28px;margin:0 0 8px;letter-spacing:.2px}
    .subtitle{color:var(--sub);font-size:13px;margin-bottom:8px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{
      background:#0b1336;color:var(--text);
      border:1px solid #2a3a86;border-radius:12px;
      padding:10px 12px;font:500 14px Inter,system-ui;
      transition:box-shadow .15s ease, transform .04s ease;
    }
    input:focus{outline:none;box-shadow:0 0 0 2px #3345b5}
    button{cursor:pointer}
    .btn{background:linear-gradient(180deg,#1d2a72,#152162);border:1px solid #2e3fb0;font-weight:600}
    .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent;border-color:#34408a}
    .pill{background:var(--chip);border:1px solid #233069;color:var(--sub);padding:6px 10px;border-radius:999px;font-size:12px}
    .stat{display:flex;gap:6px;align-items:center}
    .stat b{font-size:16px}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:auto}
    thead th{position:sticky;top:0;z-index:1;background:var(--table-head);text-align:left;font-weight:700;border-bottom:1px solid #263272}
    th,td{padding:10px 6px}
    tbody tr{border-bottom:1px solid #1e2a66}
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .num{text-align:right}
    .tinput{width:100%;background:#0b1336;border:1px solid #26337a;color:var(--text);padding:8px 8px;border-radius:8px;font:500 13px Inter,system-ui}
    .tinput:focus{box-shadow:0 0 0 2px #3345b5}
    .del{background:#1a1030;border-color:#3b1b2f} .del:hover{background:#2a153f}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .row-actions{display:flex;gap:6px;justify-content:flex-end}
    .flex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .small{font-size:12px;color:var(--sub)}
    .right{margin-left:auto}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0c1338;border:1px solid #233069;padding:2px 6px;border-radius:6px}
    .footer{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .loading{display:none;align-items:center;gap:8px}
    .loading.show{display:flex}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent)}
    .toast{position:fixed;right:16px;bottom:16px;max-width:460px;background:#10163a;border:1px solid #2a3a86;color:var(--text);padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:none;white-space:pre-wrap}
    .toast.show{display:block}
    .cfg{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
    /* Mobile: sem rolagem lateral */
    @media (max-width:900px){
      thead .hide-sm, tbody .hide-sm{display:none}
      th,td{padding:8px 4px}
      .tinput{font-size:12px;padding:6px}
      .btn{padding:8px 10px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FIIs • Carteira & Calculadora <span class="small" style="opacity:.7">v1.4</span></h1>
      <div class="subtitle">Auto-refresh apenas do <b>preço</b>. PM, cotas e dividendos ficam salvos. Compre/Desalocar como uma carteira.</div>
      <div class="controls">
        <input id="tickers" class="grow" placeholder="Ex.: HCTR11, RZAG11, MXRF11 (separe por vírgula ou espaço)" />
        <button class="btn" id="btnFetch">Buscar dados</button>
        <button class="btn ghost" id="btnAdd">Adicionar linha</button>
        <button class="btn ghost" id="btnSample">Exemplo</button>
        <div class="pill">Aporte: R$ <input id="aporte" type="number" value="300" min="1" step="1"
          style="width:110px;margin-left:6px;background:transparent;border:1px dashed #2a3a86;padding:6px 8px;border-radius:8px"/></div>
      </div>
      <div class="cfg">
        <span class="small">Chave da API <b>brapi.dev</b> (opcional):</span>
        <input id="apiKey" placeholder="cole aqui sua chave brapi (opcional)" style="min-width:260px" />
        <button class="btn ghost" id="btnSaveKey">Salvar</button>
        <button class="btn ghost" id="btnTest">Testar conexão</button>
      </div>
      <div class="flex" style="margin-top:10px">
        <div class="loading" id="loading"><span class="dot"></span><span>Atualizando…</span></div>
        <div class="small right">Cole tickers e tecle <span class="kbd">Enter</span>.</div>
      </div>
    </div>

    <div class="card">
      <div class="flex" style="margin-bottom:10px;gap:16px;flex-wrap:wrap">
        <div class="stat">Investido (custo): <b id="totCost">R$ 0,00</b></div>
        <div class="stat">Valor atual: <b id="totValue">R$ 0,00</b></div>
        <div class="stat">P/L carteira: <b id="totPL">R$ 0,00</b> <span id="totPLpct" class="small" style="margin-left:6px"></span></div>
        <div class="stat">Renda/Mês: <b id="totRenda">R$ 0,00</b></div>
        <div class="small right">Último preço: <span id="lastUpdated">—</span> • Auto-refresh <span id="refreshSec">30</span>s <button id="toggleAuto" class="btn ghost" style="padding:6px 10px">Pausar</button></div>
      </div>
      <div style="overflow:auto;border-radius:12px;border:1px solid #223069">
        <table>
          <thead>
            <tr>
              <th style="min-width:100px">Ticker</th>
              <th class="num" style="min-width:90px">Preço (live)</th>
              <th class="num" style="min-width:95px">Cotas</th>
              <th class="num" style="min-width:95px">PM</th>
              <th class="num hide-sm" style="min-width:110px">Custo</th>
              <th class="num" style="min-width:110px">Valor</th>
              <th class="num" style="min-width:100px">P/L R$</th>
              <th class="num" style="min-width:90px">P/L %</th>
              <th class="num" style="min-width:100px">Div/Mês</th>
              <th class="num" style="min-width:110px">Renda/Mês</th>
              <th style="min-width:140px"></th>
            </tr>
          </thead>
          <tbody id="body"></tbody>
        </table>
      </div>
      <div class="footer" style="margin-top:10px">
        <div class="small">Fontes: Yahoo (preço + último dividendo) • brapi (opcional). Apenas o <b>preço</b> é auto-atualizado.</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===== Utils =====
    const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const fmtPct = v => (Number(v)||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) + '%';
    const el = id => document.getElementById(id);
    const tbody = el('body');
    const state = { aporte:300, rows:[], auto:true, refresh:30, timer:null, apiKey:'' };

    function toast(msg,type='info'){
      const t = el('toast');
      t.textContent = msg;
      t.className = 'toast show';
      t.style.borderColor = (type==='error') ? '#b91c1c' : '#2a3a86';
      setTimeout(()=>{t.classList.remove('show'); t.style.borderColor='';}, 5000);
    }
    const nowStr = () => new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});

    function save(){ localStorage.setItem('fiis_calc_state_v14', JSON.stringify(state)); }
    function load(){
      try{
        const s = JSON.parse(localStorage.getItem('fiis_calc_state_v14'));
        if(s){
          state.aporte = s.aporte ?? 300;
          state.rows = Array.isArray(s.rows) ? s.rows : [];
          state.auto = (s.auto ?? true);
          state.refresh = s.refresh ?? 30;
          state.apiKey = s.apiKey ?? '';
        }
      }catch(e){}
      el('aporte').value = state.aporte;
      el('refreshSec').textContent = state.refresh;
      el('toggleAuto').textContent = state.auto ? 'Pausar' : 'Retomar';
      el('apiKey').value = state.apiKey || '';
      render();
    }

    // ===== Model helpers =====
    function toNum(x){ return Number(String(x).toString().replace(',','.'))||0; }

    function calcRow(r){
      const price = toNum(r.price);
      const pm = toNum(r.pm);
      const cotas = Number(r.cotas)||0;
      const custo = pm * cotas;
      const valor = price * cotas;
      const pl = valor - custo;
      const plPct = custo>0 ? (pl / custo * 100) : 0;
      const divm = toNum(r.divm);
      const renda = divm * cotas;
      return { price, pm, cotas, custo, valor, pl, plPct, divm, renda };
    }

    function upsertRow(incoming){
      const idx = state.rows.findIndex(x=>x.ticker===incoming.ticker);
      if(idx>=0){ state.rows[idx] = { ...state.rows[idx], ...incoming }; }
      else{
        // padrão inicial de carteira
        state.rows.push({ ticker:incoming.ticker, name:incoming.name||'', price:incoming.price||'',
          dy:incoming.dy||'', divm:incoming.divm||'', cotas:incoming.cotas||0, pm:incoming.pm||incoming.price||'' });
      }
    }

    // ===== Rendering =====
    function render(){
      tbody.innerHTML = '';
      let totCost=0, totValue=0, totRenda=0;

      state.rows.forEach((r,i)=>{
        const {price,pm,cotas,custo,valor,pl,plPct,divm,renda} = calcRow(r);
        totCost += custo; totValue += valor; totRenda += renda;
        const plClass = pl>=0 ? 'ok' : 'err';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="tinput" value="${r.ticker||''}" onchange="onEdit(${i},'ticker',this.value.toUpperCase())"/></td>
          <td class="num"><span>${price?fmtBRL(price):'-'}</span></td>
          <td class="num"><input class="tinput" type="number" min="0" step="1" value="${r.cotas||0}" onchange="onEdit(${i},'cotas',this.value)"/></td>
          <td class="num"><input class="tinput" value="${r.pm||''}" onchange="onEdit(${i},'pm',this.value)"/></td>
          <td class="num hide-sm">${custo?fmtBRL(custo):'-'}</td>
          <td class="num">${valor?fmtBRL(valor):'-'}</td>
          <td class="num ${plClass}">${pl?fmtBRL(pl):'-'}</td>
          <td class="num ${plClass}">${custo?fmtPct(plPct):'-'}</td>
          <td class="num"><input class="tinput" value="${r.divm||''}" onchange="onEdit(${i},'divm',this.value)"/></td>
          <td class="num">${renda?fmtBRL(renda):'-'}</td>
          <td>
            <div class="row-actions">
              <button class="btn ghost" onclick="alloc(${i})" title="Comprar usando o aporte atual">Alocar</button>
              <button class="btn ghost" onclick="dealloc(${i})" title="Desalocar (vender) parte das cotas">Desalocar</button>
              <button class="btn del" onclick="removeRow(${i})" title="Remover da carteira">Remover</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      el('totCost').textContent = fmtBRL(totCost);
      el('totValue').textContent = fmtBRL(totValue);
      el('totRenda').textContent = fmtBRL(totRenda);
      const totPL = totValue - totCost;
      const totPLpct = totCost>0 ? (totPL/totCost*100) : 0;
      el('totPL').textContent = fmtBRL(totPL);
      el('totPLpct').textContent = totCost ? `(${fmtPct(totPLpct)})` : '';
    }

    window.onEdit = (i,k,v)=>{ state.rows[i][k]=v; render(); save(); };
    function addRow(r={ticker:'',name:'',price:'',dy:'',divm:'',cotas:0,pm:''}){ state.rows.push(r); render(); save(); }
    function removeRow(i){ state.rows.splice(i,1); render(); save(); }

    // ===== Buy / Sell =====
    function alloc(i){
      const r = state.rows[i];
      const price = toNum(r.price);
      if(!price){ toast('Defina/atualize o preço para alocar.'); return; }
      const qtd = Math.floor(state.aporte / price);
      if(qtd<=0){ toast('Aporte insuficiente para 1 cota.'); return; }
      const cOld = Number(r.cotas)||0;
      const pmOld = toNum(r.pm)||0;
      const cNew = cOld + qtd;
      const pmNew = cOld>0 ? ((pmOld*cOld + price*qtd)/cNew) : price;
      r.cotas = cNew;
      r.pm = pmNew.toFixed(2);
      render(); save();
      toast(`Alocado: +${qtd} cota(s) em ${r.ticker} a ${fmtBRL(price)}. PM agora ${fmtBRL(pmNew)} ✔️`);
    }

    function dealloc(i){
      const r = state.rows[i];
      const c = Number(r.cotas)||0;
      if(c<=0){ toast('Sem cotas para desalocar.'); return; }
      const qtdStr = prompt(`Desalocar quantas cotas de ${r.ticker}? (disponível: ${c})`, Math.min(1,c));
      const qtd = Math.max(0, Math.min(c, Number(qtdStr)||0));
      if(qtd<=0) return;
      r.cotas = c - qtd;
      // PM mantido; custo total reduzirá naturalmente
      render(); save();
      toast(`Desalocado: -${qtd} cota(s) de ${r.ticker}.`);
    }

    // ===== Networking (com proxies) =====
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const withTimeout = (p,ms=12000)=> Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
    async function getJSON(url, opt={}){ const r = await withTimeout(fetch(url,{headers:{'Accept':'application/json'},...opt})); if(!r.ok) throw new Error('HTTP '+r.status+' em '+url); return r.json(); }
    function proxiesFor(url){ return [ url, 'https://cors.isomorphic-git.org/'+url, 'https://thingproxy.freeboard.io/fetch/'+url, 'https://api.allorigins.win/raw?url='+encodeURIComponent(url) ]; }
    async function tryChain(urls, parser){ let lastErr=null; for(const u of urls){ try{ const data=await getJSON(u); return parser?parser(data):data; }catch(e){ lastErr=e; } } throw lastErr||new Error('Falha em proxies'); }

    async function fetchFromYahooQuotes(tickers){
      const syms = tickers.map(t=>t+'.SA').join(',');
      const url = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + encodeURIComponent(syms);
      const j = await tryChain(proxiesFor(url));
      const arr = (j.quoteResponse && j.quoteResponse.result) || [];
      return arr.map(q=>({
        ticker:(q.symbol||'').replace(/\.SA$/,'').toUpperCase(),
        name:q.longName||q.shortName||'',
        price:q.regularMarketPrice ?? q.regularMarketPreviousClose ?? '',
        dy:(q.trailingAnnualDividendYield? q.trailingAnnualDividendYield*100 : ''),
        divm:''
      }));
    }
    async function fetchLastDividendYahoo(ticker){
      const sym = ticker+'.SA';
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?range=2y&interval=1d&events=div`;
      const data = await tryChain(proxiesFor(url));
      const res = data?.chart?.result?.[0];
      const events = res?.events?.dividends || null;
      if(!events) return '';
      const list = Object.values(events).sort((a,b)=>b.date - a.date);
      const last = list[0];
      const amount = last?.amount;
      return (typeof amount === 'number' ? amount : '');
    }
    async function fetchBrapi(tickers){
      const results = [];
      for(let i=0;i<tickers.length;i+=20){
        const group = tickers.slice(i,i+20);
        let url = `https://brapi.dev/api/quote/${encodeURIComponent(group.join(','))}?range=1d&interval=1d&fundamentals=true` + (state.apiKey?`&token=${encodeURIComponent(state.apiKey)}`:'');
        const j = await tryChain(proxiesFor(url), d => (d?.results || d?.stocks || d?.data || []));
        j.forEach(x=>{
          results.push({
            ticker: (x.symbol||'').replace(/\.SA$/,'').toUpperCase(),
            name: x.longName || x.shortName || '',
            price: (x.regularMarketPrice ?? x.regularMarketPreviousClose ?? ''),
            dy: (typeof x.dividendYield === 'number' && !isNaN(x.dividendYield)) ? (x.dividendYield*100) : ''
          });
        });
      }
      return results;
    }

    // Buscar dados completos (preço + nome + div/mês) — manual
    async function fetchFull(list){
      const tickers = list.map(s=>s.trim().toUpperCase().replace(/\.SA$/,'')).filter(Boolean);
      if(!tickers.length) return [];
      let base = [];
      try{ base = await fetchBrapi(tickers); }catch(_){}
      if(!base.length){ try{ base = await fetchFromYahooQuotes(tickers); }catch(_){} }
      if(!base.length){ base = tickers.map(tk=>({ticker:tk,name:'',price:'',dy:'',divm:''})); }
      // completar último dividendo
      for(const it of base){
        try{ const d = await fetchLastDividendYahoo(it.ticker); if(d) it.divm = d; }catch(_){}
        upsertRow(it);
      }
      render(); save();
    }

    // Auto-refresh: apenas PREÇOS
    async function refreshPrices(){
      const list = state.rows.map(r=>r.ticker).filter(Boolean);
      if(!list.length) return;
      try{
        const quotes = await fetchFromYahooQuotes(list);
        quotes.forEach(q=>{
          const i = state.rows.findIndex(r=>r.ticker===q.ticker);
          if(i>=0){ state.rows[i].price = q.price; } // só preço!
        });
        render(); save();
        el('lastUpdated').textContent = nowStr();
      }catch(e){ /* silencioso para não spammar toast */ }
    }

    // ===== Events =====
    function parseTickersInput(){ return el('tickers').value.trim().split(/[\s,;]+/).filter(Boolean).map(s=>s.toUpperCase()); }
    el('btnFetch').addEventListener('click', async ()=>{ const list = parseTickersInput(); if(!list.length){ toast('Informe um ticker'); return; } el('loading').classList.add('show'); try{ await fetchFull(list); }catch(e){ toast('Falha ao buscar dados: '+e.message,'error'); } finally{ el('loading').classList.remove('show'); } });
    el('tickers').addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ const list = parseTickersInput(); if(list.length){ el('loading').classList.add('show'); try{ await fetchFull(list); } finally{ el('loading').classList.remove('show'); } } }});
    el('btnAdd').addEventListener('click',()=>addRow());
    el('btnSample').addEventListener('click',()=>{
      state.rows=[
        {ticker:'HCTR11',name:'Hectare CE',price:22.70,dy:17.8,divm:0.30,cotas:10,pm:22.00},
        {ticker:'RZAG11',name:'Riza Agro',price:8.90,dy:16.0,divm:0.13,cotas:20,pm:9.10},
        {ticker:'MXRF11',name:'Maxi Renda',price:9.50,dy:12.1,divm:0.10,cotas:30,pm:9.20}
      ];
      render(); save(); toast('Exemplo carregado. Edite livremente.');
    });
    el('aporte').addEventListener('change',()=>{ state.aporte = Number(el('aporte').value)||300; render(); save(); });
    el('toggleAuto').addEventListener('click',()=>{ state.auto = !state.auto; el('toggleAuto').textContent = state.auto ? 'Pausar' : 'Retomar'; save(); if(state.auto){ startAuto(); toast('Auto-atualização ativada'); } else { stopAuto(); toast('Auto-atualização pausada'); } });
    el('btnSaveKey').addEventListener('click',()=>{ state.apiKey = el('apiKey').value.trim(); save(); toast(state.apiKey ? 'Chave brapi salva. 👌' : 'Chave removida.'); });
    el('btnTest').addEventListener('click', async ()=>{ el('loading').classList.add('show'); try{ await refreshPrices(); toast('Preço atualizado ✔️'); } catch(e){ toast('Erro no teste: '+e.message,'error'); } finally{ el('loading').classList.remove('show'); } });

    // ===== Auto refresh loop =====
    function startAuto(){ stopAuto(); if(!state.auto) return; state.timer = setInterval(refreshPrices, state.refresh*1000); }
    function stopAuto(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

    // Init
    load();
    startAuto();
    window.alloc = alloc;
    window.dealloc = dealloc;
    window.onEdit = (i,k,v)=>{ state.rows[i][k]=v; render(); save(); };
    window.removeRow = removeRow;
  </script>
</body>
</html>
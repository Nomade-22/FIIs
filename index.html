<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FIIs • Carteira em Cartões (v1.6)</title>
<style>
  :root{
    --bg:#0a0f24; --panel:#0f1532; --muted:#182151; --text:#e9ecf4; --sub:#b9c2e6;
    --accent:#7dd3fc; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    --chip:#0e1742; --border:#233069;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background:
      radial-gradient(1200px 800px at 10% -10%,#1b2a6a 0%,#0a0f24 45%),
      linear-gradient(180deg,#0a0f24,#0a0f24);
    font:500 15px/1.5 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
  }
  .wrap{max-width:1200px;margin:auto;padding:24px}
  .card, .card-lite{
    background:linear-gradient(180deg,var(--panel),#0b1230);
    border:1px solid var(--border);border-radius:18px;
    box-shadow:0 20px 45px rgba(0,0,0,.35);
  }
  .card{padding:20px;margin-bottom:18px}
  .card-lite{padding:14px}
  h1{font-size:28px;margin:0 0 8px}
  .subtitle{color:var(--sub);font-size:13px;margin-bottom:8px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,button{
    background:#0b1336;color:var(--text);border:1px solid #2a3a86;border-radius:12px;
    padding:10px 12px;font:500 14px Inter,system-ui;transition:box-shadow .15s ease, transform .04s ease;
  }
  input:focus{outline:none;box-shadow:0 0 0 2px #3345b5}
  .btn{cursor:pointer;background:linear-gradient(180deg,#1d2a72,#152162);border:1px solid #2e3fb0;font-weight:600}
  .btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
  .btn.ghost{background:transparent;border-color:#34408a}
  .pill{background:var(--chip);border:1px solid var(--border);color:var(--sub);padding:6px 10px;border-radius:999px;font-size:12px}
  .small{font-size:12px;color:var(--sub)}
  .right{margin-left:auto}
  .loading{display:none;align-items:center;gap:8px}
  .loading.show{display:flex}
  .dot{width:6px;height:6px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent)}
  .toast{
    position:fixed;right:16px;bottom:16px;max-width:460px;background:#10163a;border:1px solid #2a3a86;color:var(--text);
    padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.45);display:none;white-space:pre-wrap
  }
  .toast.show{display:block}

  /* Grade de cartões de ativos */
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
  .asset{display:flex;flex-direction:column;gap:10px}
  .asset .header{display:flex;align-items:center;gap:8px}
  .ticker{
    font-weight:800;font-size:18px;letter-spacing:.5px;
    padding:6px 10px;border-radius:10px;background:#0c1644;border:1px solid #2b3c8a
  }
  .price{margin-left:auto;font-weight:700}
  .muted{color:var(--sub)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stat{
    display:flex;flex-direction:column;gap:2px;flex:1;min-width:120px;
    background:#0a133a;border:1px solid #223069;padding:8px;border-radius:10px
  }
  .label{font-size:11px;color:var(--sub)}
  .value{font-weight:700}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .mini{padding:8px 10px;border-radius:10px}
  .num{width:100%;background:#0b1336;border:1px solid #26337a;color:var(--text);padding:8px;border-radius:8px;font:500 13px Inter}

  /* Bandeja nova */
  .grid-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .chipline{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .chip{background:#0c1644;border:1px solid #2b3c8a;color:#d8defd;padding:6px 10px;border-radius:999px;font-weight:700}
  .minigrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-top:10px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>FIIs • Carteira (Cartões) <span class="small" style="opacity:.7">v1.6</span></h1>
      <div class="subtitle">Sem rolagem lateral. Preço atualiza automático; PM, cotas e dividendos ficam salvos. Compre/Desalocar como carteira.</div>
      <div class="controls">
        <input id="tickers" class="grow" placeholder="Ex.: HCTR11, RZAG11, MXRF11 (separe por vírgula ou espaço)"/>
        <button class="btn" id="btnFetch">Adicionar/Atualizar</button>
        <button class="btn ghost" id="btnSample">Exemplo</button>
        <div class="pill">Aporte: R$ <input id="aporte" type="number" value="300" min="1" step="1" style="width:110px;margin-left:6px;background:transparent;border:1px dashed #2a3a86;padding:6px 8px;border-radius:8px"/></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="small">Chave brapi (opcional): <input id="apiKey" placeholder="cole aqui sua chave brapi" style="min-width:220px"/></div>
        <button class="btn ghost mini" id="btnSaveKey">Salvar chave</button>
        <button class="btn ghost mini" id="btnTest">Testar preço</button>
        <div class="loading" id="loading"><span class="dot"></span><span>Atualizando preços…</span></div>
        <div class="small right">Auto-refresh: <span id="refreshSec">30</span>s <button id="toggleAuto" class="btn ghost mini">Pausar</button></div>
      </div>
    </div>

    <!-- BANDEJA: totais + chips + mini-indicadores -->
    <div class="card-lite" style="margin-bottom:14px">
      <div class="grid-summary">
        <div class="stat"><span class="label">Investido (custo)</span><span class="value" id="totCost">R$ 0,00</span></div>
        <div class="stat"><span class="label">Valor atual</span><span class="value" id="totValue">R$ 0,00</span></div>
        <div class="stat">
          <span class="label">P/L carteira</span>
          <span class="value"><span id="totPL">R$ 0,00</span> <span id="totPLpct" class="muted"></span></span>
        </div>
        <div class="stat"><span class="label">Renda/Mês</span><span class="value" id="totRenda">R$ 0,00</span></div>
        <div class="stat"><span class="label">Última atualização</span><span class="value" id="lastUpdated">—</span></div>
      </div>

      <div class="section-title" style="margin-top:10px;font-weight:700;color:#cfd6ff">Posições (Ticker × Cotas)</div>
      <div id="positions" class="chipline"></div>

      <div class="section-title" style="margin-top:6px;font-weight:700;color:#cfd6ff">Indicadores</div>
      <div class="minigrid">
        <div class="stat"><span class="label">Ativos</span><span class="value" id="indAtivos">0</span></div>
        <div class="stat"><span class="label">Cotas totais</span><span class="value" id="indCotas">0</span></div>
        <div class="stat"><span class="label">PM ponderado</span><span class="value" id="indPM">R$ 0,00</span></div>
        <div class="stat"><span class="label">Yield mensal</span><span class="value" id="indYield">0,00%</span></div>
        <div class="stat"><span class="label">Maior posição</span><span class="value" id="indMaior">0,00%</span></div>
        <div class="stat"><span class="label">Top-3 concentração</span><span class="value" id="indTop3">0,00%</span></div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===== Utils & State =====
    const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const fmtPct = v => (Number(v)||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2}) + '%';
    const el = id => document.getElementById(id);
    const grid = el('grid');
    const state = { aporte:300, items:[], auto:true, refresh:30, timer:null, apiKey:'' };

    function toast(msg,type='info'){
      const t = el('toast');
      t.textContent = msg;
      t.className = 'toast show';
      t.style.borderColor = (type==='error') ? '#b91c1c' : '#2a3a86';
      setTimeout(()=>{t.classList.remove('show'); t.style.borderColor='';}, 4500);
    }
    const nowStr = () => new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const num = x => Number(String(x).replace(',','.'))||0;

    function save(){ localStorage.setItem('fiis_cards_v16', JSON.stringify(state)); }
    function load(){
      try{
        const s = JSON.parse(localStorage.getItem('fiis_cards_v16'));
        if(s){
          state.aporte = s.aporte ?? 300;
          state.items = Array.isArray(s.items) ? s.items : [];
          state.auto = (s.auto ?? true);
          state.refresh = s.refresh ?? 30;
          state.apiKey = s.apiKey ?? '';
        }
      }catch(e){}
      el('aporte').value = state.aporte;
      el('refreshSec').textContent = state.refresh;
      el('toggleAuto').textContent = state.auto ? 'Pausar' : 'Retomar';
      el('apiKey').value = state.apiKey || '';
      render();
    }

    // ===== Model / Calculations =====
    function upsert(item){
      const i = state.items.findIndex(x=>x.ticker===item.ticker);
      if(i>=0) state.items[i] = {...state.items[i], ...item};
      else state.items.push({ticker:item.ticker, name:item.name||'', price:item.price||'', dy:item.dy||'',
                             divm:item.divm||'', cotas:item.cotas||0, pm:item.pm||(item.price||'')});
    }
    function calc(it){
      const price = num(it.price), pm=num(it.pm), cotas=Number(it.cotas)||0, d=num(it.divm);
      const custo = pm*cotas, valor = price*cotas, pl = valor-custo, plPct = custo>0? (pl/custo*100):0, renda = d*cotas;
      return {price, pm, cotas, d, custo, valor, pl, plPct, renda};
    }

    // ===== Rendering (cards + bandeja) =====
    function render(){
      grid.innerHTML = '';
      // --- ativos/cards
      let totCost=0, totValue=0, totRenda=0;
      const pos = []; // para indicadores/chips

      state.items.forEach((it,idx)=>{
        const {price, pm, cotas, d, custo, valor, pl, plPct, renda} = calc(it);
        totCost += custo; totValue += valor; totRenda += renda;
        if(cotas>0) pos.push({ticker:it.ticker, valor, cotas});

        const plClass = pl>=0 ? 'ok' : 'err';
        const card = document.createElement('div');
        card.className = 'card-lite asset';
        card.innerHTML = `
          <div class="header">
            <span class="ticker">${it.ticker||''}</span>
            <span class="muted">(${it.name||''})</span>
            <span class="price">${price?fmtBRL(price):'-'}</span>
          </div>

          <div class="row">
            <div class="stat">
              <span class="label">PM (Preço Médio)</span>
              <input class="num" value="${it.pm||''}" onchange="onEdit(${idx},'pm',this.value)" />
            </div>
            <div class="stat">
              <span class="label">Cotas</span>
              <input class="num" type="number" min="0" step="1" value="${it.cotas||0}" onchange="onEdit(${idx},'cotas',this.value)"/>
            </div>
            <div class="stat">
              <span class="label">Div/Mês (R$)</span>
              <input class="num" value="${it.divm||''}" onchange="onEdit(${idx},'divm',this.value)"/>
            </div>
          </div>

          <div class="row">
            <div class="stat"><span class="label">Custo</span><span class="value">${custo?fmtBRL(custo):'-'}</span></div>
            <div class="stat"><span class="label">Valor</span><span class="value">${valor?fmtBRL(valor):'-'}</span></div>
            <div class="stat"><span class="label">P/L</span><span class="value ${plClass}">${pl?fmtBRL(pl):'-'} <span class="muted">${custo? '('+fmtPct(plPct)+')' : ''}</span></span></div>
            <div class="stat"><span class="label">Renda/Mês</span><span class="value">${renda?fmtBRL(renda):'-'}</span></div>
          </div>

          <div class="actions">
            <button class="btn ghost mini" onclick="alloc(${idx})" title="Comprar com o aporte">Alocar</button>
            <button class="btn ghost mini" onclick="dealloc(${idx})" title="Vender parte">Desalocar</button>
            <button class="btn ghost mini" onclick="refreshOne(${idx})" title="Atualizar preço">↻ Preço</button>
            <button class="btn mini" style="background:#1a1030;border-color:#3b1b2f" onclick="removeItem(${idx})">Remover</button>
          </div>
        `;
        grid.appendChild(card);
      });

      // --- totais
      el('totCost').textContent = fmtBRL(totCost);
      el('totValue').textContent = fmtBRL(totValue);
      el('totRenda').textContent = fmtBRL(totRenda);
      const totPL = totValue - totCost;
      const totPLpct = totCost>0 ? (totPL/totCost*100) : 0;
      el('totPL').textContent = fmtBRL(totPL);
      el('totPLpct').textContent = totCost ? `(${fmtPct(totPLpct)})` : '';

      // --- chips de posições
      const chips = pos
        .sort((a,b)=>b.valor-a.valor)
        .map(p=>`<span class="chip">${p.ticker} × ${p.cotas}</span>`)
        .join('');
      el('positions').innerHTML = chips || '<span class="small">Nenhuma posição alocada</span>';

      // --- mini-indicadores
      const ativos = pos.length;
      const cotasTot = pos.reduce((s,p)=>s+p.cotas,0);
      const pmPond = cotasTot>0
        ? (state.items.reduce((s,it)=>s + num(it.pm)*(Number(it.cotas)||0),0)/cotasTot)
        : 0;
      const yieldMensal = (totValue>0) ? (totRenda/totValue*100) : 0;
      const maior = (totValue>0 && ativos>0) ? (pos[0].valor/totValue*100) : 0;
      const top3 = (totValue>0) ? (pos.slice(0,3).reduce((s,p)=>s+p.valor,0)/totValue*100) : 0;

      el('indAtivos').textContent = ativos;
      el('indCotas').textContent = cotasTot;
      el('indPM').textContent = fmtBRL(pmPond);
      el('indYield').textContent = fmtPct(yieldMensal);
      el('indMaior').textContent = fmtPct(maior);
      el('indTop3').textContent = fmtPct(top3);
    }

    // edição & remoção
    window.onEdit = (i,k,v)=>{ state.items[i][k]=v; render(); save(); };
    window.removeItem = (i)=>{ state.items.splice(i,1); render(); save(); };

    // comprar / vender
    window.alloc = (i)=>{
      const it = state.items[i]; const price = num(it.price);
      if(!price){ toast('Atualize o preço antes de alocar.'); return; }
      const qtd = Math.floor(state.aporte / price);
      if(qtd<=0){ toast('Aporte insuficiente para 1 cota.'); return; }
      const cOld = Number(it.cotas)||0, pmOld=num(it.pm)||0;
      const cNew=cOld+qtd, pmNew = cOld>0 ? ((pmOld*cOld + price*qtd)/cNew) : price;
      it.cotas=cNew; it.pm=pmNew.toFixed(2);
      render(); save();
      toast(`Alocado +${qtd} cota(s) em ${it.ticker} a ${fmtBRL(price)}. PM ${fmtBRL(pmNew)}.`);
    };
    window.dealloc = (i)=>{
      const it = state.items[i]; const c = Number(it.cotas)||0;
      if(c<=0){ toast('Sem cotas para desalocar.'); return; }
      const qtd = Math.max(0, Math.min(c, Number(prompt(`Desalocar quantas cotas de ${it.ticker}? (disp: ${c})`, 1))||0));
      if(qtd<=0) return;
      it.cotas = c - qtd; // PM mantido
      render(); save();
      toast(`Desalocado -${qtd} cota(s) de ${it.ticker}.`);
    };

    // ===== Networking (preço + nome + dividendo) =====
    const withTimeout = (p,ms=12000)=> Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
    async function getJSON(url, opt={}){ const r = await withTimeout(fetch(url,{headers:{'Accept':'application/json'},...opt})); if(!r.ok) throw new Error('HTTP '+r.status+' em '+url); return r.json(); }
    function proxiesFor(url){ return [ url, 'https://cors.isomorphic-git.org/'+url, 'https://thingproxy.freeboard.io/fetch/'+url, 'https://api.allorigins.win/raw?url='+encodeURIComponent(url) ]; }
    async function tryChain(urls, parser){ let lastErr=null; for(const u of urls){ try{ const data=await getJSON(u); return parser?parser(data):data; }catch(e){ lastErr=e; } } throw lastErr||new Error('Falha em proxies'); }

    async function fetchYahooQuotes(tickers){
      const syms = tickers.map(t=>t+'.SA').join(',');
      const url = 'https://query1.finance.yahoo.com/v7/finance/quote?symbols=' + encodeURIComponent(syms);
      const j = await tryChain(proxiesFor(url));
      const arr = (j.quoteResponse && j.quoteResponse.result) || [];
      return arr.map(q=>({
        ticker:(q.symbol||'').replace(/\.SA$/,'').toUpperCase(),
        name:q.longName||q.shortName||'',
        price:q.regularMarketPrice ?? q.regularMarketPreviousClose ?? '',
        dy:(q.trailingAnnualDividendYield? q.trailingAnnualDividendYield*100 : '')
      }));
    }
    async function fetchYahooLastDiv(ticker){
      const sym = ticker+'.SA';
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?range=2y&interval=1d&events=div`;
      const data = await tryChain(proxiesFor(url));
      const res = data?.chart?.result?.[0];
      const events = res?.events?.dividends || null;
      if(!events) return '';
      const list = Object.values(events).sort((a,b)=>b.date - a.date);
      const last = list[0]; const amount = last?.amount;
      return (typeof amount === 'number' ? amount : '');
    }
    async function fetchBrapi(tickers){
      const out=[]; for(let i=0;i<tickers.length;i+=20){
        const group = tickers.slice(i,i+20);
        let url = `https://brapi.dev/api/quote/${encodeURIComponent(group.join(','))}?range=1d&interval=1d&fundamentals=true` + (state.apiKey?`&token=${encodeURIComponent(state.apiKey)}`:'');
        const j = await tryChain(proxiesFor(url), d => (d?.results || d?.stocks || d?.data || []));
        j.forEach(x=> out.push({ticker:(x.symbol||'').replace(/\.SA$/,'').toUpperCase(), name:x.longName||x.shortName||'', price:(x.regularMarketPrice ?? x.regularMarketPreviousClose ?? ''), dy:(typeof x.dividendYield==='number'? x.dividendYield*100 : '')}));
      } return out;
    }

    async function addOrUpdateTickers(listRaw){
      const tickers = listRaw.map(s=>s.trim().toUpperCase().replace(/\.SA$/,'')).filter(Boolean);
      if(!tickers.length) return;
      el('loading').classList.add('show');
      try{
        let base=[]; try{ base = await fetchBrapi(tickers); }catch(_){}
        if(!base.length){ try{ base = await fetchYahooQuotes(tickers); }catch(_){}
        }
        if(!base.length){ base = tickers.map(tk=>({ticker:tk,name:'',price:'',dy:''})); }
        for(const it of base){
          try{ const d = await fetchYahooLastDiv(it.ticker); if(d) it.divm = d; }catch(_){}
          upsert(it);
        }
        render(); save();
      }catch(e){ toast('Falha ao buscar: '+e.message,'error'); }
      finally{ el('loading').classList.remove('show'); el('lastUpdated').textContent = nowStr(); }
    }

    // Apenas PREÇOS (auto refresh)
    async function refreshPrices(){
      const list = state.items.map(x=>x.ticker).filter(Boolean);
      if(!list.length) return;
      try{
        const q = await fetchYahooQuotes(list);
        q.forEach(it=>{
          const i = state.items.findIndex(x=>x.ticker===it.ticker);
          if(i>=0){ state.items[i].price = it.price; } // só preço!
        });
        render(); save();
        el('lastUpdated').textContent = nowStr();
      }catch(e){ /* silencioso */ }
    }
    window.refreshOne = async (i)=>{
      const tk = state.items[i]?.ticker; if(!tk) return;
      try{
        const q = await fetchYahooQuotes([tk]);
        if(q[0]){ state.items[i].price = q[0].price; render(); save(); el('lastUpdated').textContent = nowStr(); }
      }catch(e){ toast('Falha ao atualizar preço: '+e.message,'error'); }
    };

    // ===== Events & Init =====
    function parseTickers(){ return el('tickers').value.trim().split(/[\s,;]+/).filter(Boolean).map(s=>s.toUpperCase()); }
    el('btnFetch').addEventListener('click', async ()=>{ const list = parseTickers(); if(!list.length){ toast('Informe ao menos um ticker'); return; } await addOrUpdateTickers(list); });
    el('tickers').addEventListener('keydown', async (e)=>{ if(e.key==='Enter'){ const list = parseTickers(); if(list.length) await addOrUpdateTickers(list); }});
    el('btnSample').addEventListener('click', async ()=>{
      await addOrUpdateTickers(['HCTR11','RZAG11','MXRF11']);
      state.items = state.items.map(x=>{
        if(x.ticker==='HCTR11') return {...x, cotas:10, pm:x.price||22.0};
        if(x.ticker==='RZAG11') return {...x, cotas:20, pm:x.price||9.1};
        if(x.ticker==='MXRF11') return {...x, cotas:30, pm:x.price||9.2};
        return x;
      });
      render(); save(); toast('Exemplo carregado. Edite livremente.');
    });
    el('aporte').addEventListener('change',()=>{ state.aporte = Number(el('aporte').value)||300; save(); });
    el('btnSaveKey').addEventListener('click',()=>{ state.apiKey = el('apiKey').value.trim(); save(); toast(state.apiKey ? 'Chave brapi salva. 👌' : 'Chave removida.'); });
    el('btnTest').addEventListener('click', async ()=>{ el('loading').classList.add('show'); try{ await refreshPrices(); toast('Preços atualizados ✔️'); } catch(e){ toast('Erro: '+e.message,'error'); } finally{ el('loading').classList.remove('show'); } });
    function startAuto(){ stopAuto(); if(!state.auto) return; state.timer = setInterval(refreshPrices, state.refresh*1000); }
    function stopAuto(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }
    el('toggleAuto').addEventListener('click',()=>{ state.auto=!state.auto; el('toggleAuto').textContent = state.auto ? 'Pausar' : 'Retomar'; save(); if(state.auto){ startAuto(); toast('Auto-atualização ON'); } else { stopAuto(); toast('Auto-atualização OFF'); } });

    load();
    startAuto();
    // Expose for inline handlers:
    window.onEdit = (i,k,v)=>{ state.items[i][k]=v; render(); save(); };
    window.removeItem = (i)=>{ state.items.splice(i,1); render(); save(); };
    window.alloc = (i)=>{ const it = state.items[i]; const price = num(it.price); if(!price){ toast('Atualize o preço antes de alocar.'); return; } const qtd = Math.floor(state.aporte / price); if(qtd<=0){ toast('Aporte insuficiente para 1 cota.'); return; } const cOld = Number(it.cotas)||0, pmOld=num(it.pm)||0; const cNew=cOld+qtd, pmNew = cOld>0 ? ((pmOld*cOld + price*qtd)/cNew) : price; it.cotas=cNew; it.pm=pmNew.toFixed(2); render(); save(); toast(`Alocado +${qtd} cota(s) em ${it.ticker}.`); };
    window.dealloc = (i)=>{ const it = state.items[i]; const c = Number(it.cotas)||0; if(c<=0){ toast('Sem cotas para desalocar.'); return; } const qtd = Math.max(0, Math.min(c, Number(prompt(`Desalocar quantas cotas de ${it.ticker}? (disp: ${c})`, 1))||0)); if(qtd<=0) return; it.cotas = c - qtd; render(); save(); toast(`Desalocado -${qtd} cota(s) de ${it.ticker}.`); };
    window.refreshOne = window.refreshOne;
  </script>
</body>
</html>